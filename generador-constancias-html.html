<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSTANCIA DE LIBERACIÓN Y NO ADEUDO</title>

    <!-- Se importa la librería para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- =================================================================
         INICIA SECCIÓN DE ESTILOS (CSS)
         ================================================================= -->
    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: #ffffff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #0056b3;
            text-align: center;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        /* --- Estilos para Agrupar Secciones --- */
        fieldset {
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 25px;
        }

        legend {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            padding: 0 10px;
        }
        
        /* --- Estilos para los Campos del Formulario --- */
        .campo-formulario {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #4b4f56;
        }

        input[type="text"],
        input[type="date"] {
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box; /* Asegura que el padding no afecte el ancho total */
        }
        
        input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.2);
        }

        /* --- Clases para controlar el ANCHO de los inputs --- */
        .ancho-completo { width: 100%; }
        .ancho-grande { width: 65%; }
        .ancho-mediano { width: 40%; }
        .ancho-pequeno { width: 25%; }
        
        /* Contenedor para alinear campos en la misma línea */
        .fila {
            display: flex;
            gap: 20px; /* Espacio entre los campos */
            flex-wrap: wrap; /* Permite que los campos se reorganicen en pantallas pequeñas */
        }
        .fila > div {
            flex: 1 1 auto; /* Permite que los campos crezcan y se encojan */
        }

        /* --- Estilo del Botón --- */
        .boton-contenedor {
            text-align: right; /* Alinea el botón a la derecha */
        }
        
        button {
            background-color: #0056b3;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #004494;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- ENLACE AÑADIDO -->
        <a href="generador-menu.html" style="text-decoration: none; color: #0056b3; font-weight: bold; display: block; margin-bottom: 20px;">&larr; Volver al Menú</a>

        <h1>CONSTANCIA DE LIBERACIÓN Y NO ADEUDO</h1>

        <form id="oficioForm">

            <!-- ========= GRUPO 1: DATOS DEL DOCUMENTO ========= -->
            <fieldset>
                <legend>Datos del Documento</legend>
                <div class="fila">
                    <div class="campo-formulario" style="flex-grow: 2;">
                        <label for="lugar">Lugar de expedición:</label>
                        <input type="text" id="lugar" name="lugar" class="ancho-completo">
                    </div>
                    <div class="campo-formulario">
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" class="ancho-completo">
                    </div>
                </div>
            </fieldset>

            <!-- ========= GRUPO 2: DATOS DE LA ESCUELA ========= -->
            <fieldset>
                <legend>Datos de la Escuela</legend>
                <div class="campo-formulario">
                    <label for="nombreDirector">Nombre del Director(a):</label>
                    <input type="text" id="nombreDirector" name="nombreDirector" class="ancho-completo">
                </div>
                <div class="fila">
                    <div class="campo-formulario" style="flex-grow: 2;">
                        <label for="nombreEscuela">Nombre de la Escuela:</label>
                        <input type="text" id="nombreEscuela" name="nombreEscuela" class="ancho-completo">
                    </div>
                    <div class="campo-formulario">
                        <label for="claveEscuela">Clave de la Escuela:</label>
                        <input type="text" id="claveEscuela" name="claveEscuela" class="ancho-completo">
                    </div>
                </div>
                <div class="campo-formulario">
                    <label for="nombreAPF">Nombre del Presidente(a) de la APF:</label>
                    <input type="text" id="nombreAPF" name="nombreAPF" class="ancho-completo">
                </div>
            </fieldset>

            <!-- ========= GRUPO 3: DATOS DEL DOCENTE ========= -->
            <fieldset>
                <legend>Datos del Docente</legend>
                <div class="campo-formulario">
                    <label for="nombreDocente">Nombre del Docente:</label>
                    <input type="text" id="nombreDocente" name="nombreDocente" class="ancho-completo">
                </div>
                <div class="fila">
                    <div class="campo-formulario">
                        <label for="rfcDocente">RFC:</label>
                        <input type="text" id="rfcDocente" name="rfcDocente" class="ancho-mediano">
                    </div>
                    <div class="campo-formulario">
                        <label for="clavePresupuestal">Clave Presupuestal:</label>
                        <input type="text" id="clavePresupuestal" name="clavePresupuestal" class="ancho-grande">
                    </div>
                    <div class="campo-formulario">
                        <label for="fechaEfectos">Fecha para efectos:</label>
                        <input type="date" id="fechaEfectos" name="fechaEfectos" class="ancho-completo">
                    </div>
                </div>
            </fieldset>
            
            <!-- ========= BOTÓN PARA GENERAR EL DOCUMENTO ========= -->
            <div class="boton-contenedor">
                <button type="button" id="generarPdfBtn">Generar PDF</button>
            </div>

        </form>
    </div>

    <!-- =================================================================
         INICIA SECCIÓN DE JAVASCRIPT
         ================================================================= -->
    <script>
        document.getElementById('generarPdfBtn').addEventListener('click', function() {

            // --- 1. OBTENER DATOS DEL FORMULARIO ---
            const data = {
                lugar: document.getElementById('lugar').value,
                fecha: document.getElementById('fecha').value,
                nombreDirector: document.getElementById('nombreDirector').value,
                nombreEscuela: document.getElementById('nombreEscuela').value,
                claveEscuela: document.getElementById('claveEscuela').value,
                nombreAPF: document.getElementById('nombreAPF').value,
                nombreDocente: document.getElementById('nombreDocente').value,
                rfcDocente: document.getElementById('rfcDocente').value,
                clavePresupuestal: document.getElementById('clavePresupuestal').value,
                fechaEfectos: document.getElementById('fechaEfectos').value
            };

            // --- 2. PREPARAR LA IMAGEN DEL MEMBRETE ---
            const membreteUrl = 'https://i.imgur.com/EDW2iok.png'; 

            const img = new Image();
            img.crossOrigin = 'Anonymous'; // Necesario para que el navegador permita cargar la imagen
            
            img.onload = function() {
                // La función para generar el PDF se ejecuta SÓLO DESPUÉS de que la imagen se haya cargado
                generarElPDF(this); 
            };
            
            img.onerror = function() {
                // Si hay un error al cargar la imagen, se genera el PDF sin ella.
                console.error("No se pudo cargar la imagen del membrete desde la URL. Revisa el enlace.");
                generarElPDF(null); // Llama a la función sin imagen
            };

            img.src = membreteUrl; // Inicia la carga de la imagen

            // --- 3. FUNCIÓN PRINCIPAL PARA GENERAR EL PDF ---
            function generarElPDF(membreteImg) {
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'letter');
                const margenIzquierdo = 20;
                const anchoMaximoTexto = doc.internal.pageSize.getWidth() - margenIzquierdo * 2;
                let y = 20; // Posición vertical inicial

                // Añadir membrete si se cargó correctamente
                if (membreteImg) {
                    const imgWidth = 90; // Ancho de la imagen en mm (AUMENTADO)
                    const imgHeight = (membreteImg.height * imgWidth) / membreteImg.width; // Mantiene la proporción
                    doc.addImage(membreteImg, 'PNG', margenIzquierdo, y, imgWidth, imgHeight);
                    y += imgHeight + 5; // Ajustar la posición vertical para el texto
                }
                
                const margenSuperior = y; // El margen superior ahora depende de la imagen

                doc.setFont('times', 'normal');
                doc.setFontSize(12);

                // --- Funciones para justificar texto ---
                function printLine(lineWords, x, y, maxWidth, isLastLine) {
                    let totalWordsWidth = 0;
                    lineWords.forEach(word => {
                        doc.setFont('times', word.style === 'bold' ? 'bold' : 'normal');
                        totalWordsWidth += doc.getTextWidth(word.text);
                    });

                    let spacing = doc.getTextWidth(' ');
                    if (!isLastLine && lineWords.length > 1) {
                        spacing = (maxWidth - totalWordsWidth) / (lineWords.length - 1);
                    }

                    let cursorX = x;
                    lineWords.forEach(word => {
                        doc.setFont('times', word.style === 'bold' ? 'bold' : 'normal');
                        doc.text(word.text, cursorX, y);
                        cursorX += doc.getTextWidth(word.text) + spacing;
                    });
                }

                function printJustifiedAdvancedText(fragments, x, y, maxWidth, lineHeight) {
                    let allWords = [];
                    fragments.forEach(fragment => {
                        fragment.text.split(/\s+/).forEach(word => {
                            if (word.length > 0) {
                                allWords.push({ text: word, style: fragment.style });
                            }
                        });
                    });

                    let currentLine = [];
                    let currentLineWidth = 0;
                    const spaceWidth = doc.getTextWidth(' ');
                    let cursorY = y;

                    for (let i = 0; i < allWords.length; i++) {
                        const word = allWords[i];
                        doc.setFont('times', word.style === 'bold' ? 'bold' : 'normal');
                        const wordWidth = doc.getTextWidth(word.text);
                        const potentialWidth = currentLineWidth + (currentLine.length > 0 ? spaceWidth : 0) + wordWidth;

                        if (potentialWidth > maxWidth && currentLine.length > 0) {
                            printLine(currentLine, x, cursorY, maxWidth, false);
                            cursorY += lineHeight;
                            currentLine = [word];
                            currentLineWidth = wordWidth;
                        } else {
                            currentLine.push(word);
                            currentLineWidth += (currentLine.length > 1 ? spaceWidth : 0) + wordWidth;
                        }
                    }

                    if (currentLine.length > 0) {
                        printLine(currentLine, x, cursorY, maxWidth, true);
                        cursorY += lineHeight;
                    }
                    return cursorY;
                }

                function formatearFecha(fechaStr) {
                    if (!fechaStr) return 'FECHA NO ESPECIFICADA';
                    const fechaObj = new Date(fechaStr + 'T00:00:00');
                    const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
                    return fechaObj.toLocaleDateString('es-ES', opciones);
                }

                // --- CONSTRUCCIÓN DEL TEXTO DEL PDF ---
                doc.setFont('times', 'bold');
                doc.text("ASUNTO: Constancia de liberación y no adeudo.", anchoMaximoTexto + margenIzquierdo, margenSuperior, { align: 'right' });
                doc.setFont('times', 'normal');
                doc.text(`${data.lugar}, a ${formatearFecha(data.fecha)}`, anchoMaximoTexto + margenIzquierdo, margenSuperior + 10, { align: 'right' });

                y = margenSuperior + 15;
                doc.setFont('times', 'bold');
                doc.text("LIC. JOSÉ CONDE GÓMEZ", margenIzquierdo, y);
                y += 5; doc.text("DIRECTOR GENERAL DE EDUCACIÓN", margenIzquierdo, y);
                y += 5; doc.text("PRIMARIA FEDERALIZADA.", margenIzquierdo, y);
                y += 5; doc.text("XALAPA, VER.", margenIzquierdo, y);
                y += 5; doc.text("PRESENTE.", margenIzquierdo, y);
                y += 15;

                const cuerpoTexto1 = `El que suscribe, Mtro. Joaquín Rodríguez Vázquez, Supervisor de Zona de Educación Primaria General Num. 035, con sede en Tlapacoyan, Ver., y en pleno uso de la autoridad conferida en mi mediante el nombramiento que ostento.`;
                const fragments1 = [{ text: cuerpoTexto1, style: 'normal' }];
                y = printJustifiedAdvancedText(fragments1, margenIzquierdo, y, anchoMaximoTexto, 5);
                y += 5;

                doc.setFont('times', 'bold');
                doc.text("HAGO CONSTAR", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                y += 10;

                const fragments2 = [
                    { text: 'Para los usos legales y administrativos a que diera lugar, y a petición del interesado, que el(la) C.', style: 'normal' },
                    { text: data.nombreDocente, style: 'bold' },
                    { text: ', R.F.C.:', style: 'normal' },
                    { text: data.rfcDocente, style: 'bold' },
                    { text: ', con clave presupuestal', style: 'normal' },
                    { text: data.clavePresupuestal, style: 'bold' },
                    { text: 'adscrito(a) al CT:', style: 'normal' },
                    { text: data.nombreEscuela, style: 'bold' },
                    { text: '. Clave:', style: 'normal' },
                    { text: data.claveEscuela, style: 'bold' },
                    { text: ', ha cumplido en tiempo y forma con las actividades laborales que ha venido desempeñando y no tiene ningún adeudo pendiente, administrativo ni económico; por lo que no existe ningún inconveniente en otorgarle la liberación correspondiente, con efectos a partir del:', style: 'normal' },
                    { text: formatearFecha(data.fechaEfectos), style: 'bold' }
                ];
                y = printJustifiedAdvancedText(fragments2, margenIzquierdo, y, anchoMaximoTexto, 5);
                y += 5;

                const despedida = "Sin otro particular, para los fines que al interesado convengan, quedo de usted.";
                const fragmentsDespedida = [{ text: despedida, style: 'normal' }];
                y = printJustifiedAdvancedText(fragmentsDespedida, margenIzquierdo, y, anchoMaximoTexto, 5);
                y += 10;

                doc.setFont('times', 'bold');
                doc.text("ATENTAMENTE", doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
                
                let yFirmas = doc.internal.pageSize.getHeight() - 60;
                const col1 = margenIzquierdo + 15;
                const col2 = doc.internal.pageSize.getWidth() / 2;
                const col3 = doc.internal.pageSize.getWidth() - margenIzquierdo - 15;

                doc.setFontSize(10);
                doc.text(data.nombreDirector.toUpperCase(), col1, yFirmas, { align: 'center' });
                doc.text("MTRO. JOAQUÍN RODRÍGUEZ VÁZQUEZ", col2, yFirmas, { align: 'center' });
                doc.text(data.nombreAPF.toUpperCase(), col3, yFirmas, { align: 'center' });
                
                doc.setFont('times', 'normal');
                doc.text("Director(a) de la Escuela", col1, yFirmas + 5, { align: 'center' });
                const textoSupervisor = doc.splitTextToSize("SUPERVISOR DE ZONA DE EDUCACIÓN PRIMARIA GENERAL NUM. 035", 60);
                doc.text(textoSupervisor, col2, yFirmas + 5, { align: 'center' });
                doc.text("PRESIDENTE(A) DE LA APF", col3, yFirmas + 5, { align: 'center' });

                doc.save(`Constancia_${data.nombreDocente.replace(/\s/g, '_')}.pdf`);
            }
        });
    </script>

</body>
</html>
